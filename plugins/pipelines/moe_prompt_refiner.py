import os
from typing import List, Optional
from pydantic import BaseModel
import time


class Pipeline:
    """
    è¯¥ç®¡é“ç”¨äºä¼˜åŒ–å¤šæ¨¡å‹ï¼ˆMoEï¼‰æ±‡æ€»è¯·æ±‚çš„æç¤ºè¯ã€‚

    å®ƒä¼šæ‹¦æˆªç”¨äºæ±‡æ€»å¤šä¸ªæ¨¡å‹å“åº”çš„è¯·æ±‚ï¼Œæå–åŸå§‹ç”¨æˆ·æŸ¥è¯¢å’Œå„ä¸ªæ¨¡å‹çš„å…·ä½“å›ç­”ï¼Œ
    ç„¶åæ„å»ºä¸€ä¸ªæ–°çš„ã€æ›´è¯¦ç»†ã€ç»“æ„åŒ–çš„æç¤ºè¯ã€‚

    è¿™ä¸ªç»è¿‡ä¼˜åŒ–çš„æç¤ºè¯ä¼šå¼•å¯¼æœ€ç»ˆçš„æ±‡æ€»æ¨¡å‹æ‰®æ¼”ä¸€ä¸ªä¸“å®¶åˆ†æå¸ˆçš„è§’è‰²ï¼Œ
    å°†è¾“å…¥ä¿¡æ¯æ•´åˆæˆä¸€ä»½é«˜è´¨é‡ã€å…¨é¢çš„ç»¼åˆæŠ¥å‘Šã€‚
    """

    class Valves(BaseModel):
        # æŒ‡å®šè¯¥è¿‡æ»¤å™¨ç®¡é“å°†è¿æ¥åˆ°çš„ç›®æ ‡ç®¡é“IDï¼ˆæ¨¡å‹ï¼‰ã€‚
        # å¦‚æœå¸Œæœ›è¿æ¥åˆ°æ‰€æœ‰ç®¡é“ï¼Œå¯ä»¥è®¾ç½®ä¸º ["*"]ã€‚
        pipelines: List[str] = ["*"]

        # ä¸ºè¿‡æ»¤å™¨ç®¡é“åˆ†é…ä¸€ä¸ªä¼˜å…ˆçº§ã€‚
        # ä¼˜å…ˆçº§å†³å®šäº†è¿‡æ»¤å™¨ç®¡é“çš„æ‰§è¡Œé¡ºåºã€‚
        # æ•°å­—è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚
        priority: int = 0

    def __init__(self):
        self.type = "filter"
        self.name = "moe_prompt_refiner"
        self.valves = self.Valves()

    async def on_startup(self):
        # æ­¤å‡½æ•°åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è°ƒç”¨ã€‚
        # print(f"on_startup:{__name__}")
        pass

    async def on_shutdown(self):
        # æ­¤å‡½æ•°åœ¨æœåŠ¡å™¨åœæ­¢æ—¶è°ƒç”¨ã€‚
        # print(f"on_shutdown:{__name__}")
        pass

    async def inlet(self, body: dict, user: Optional[dict] = None) -> dict:
        """
        æ­¤æ–¹æ³•æ˜¯ç®¡é“çš„å…¥å£ç‚¹ã€‚

        å®ƒä¼šæ£€æŸ¥ä¼ å…¥çš„è¯·æ±‚æ˜¯å¦ä¸ºå¤šæ¨¡å‹ï¼ˆMoEï¼‰æ±‡æ€»è¯·æ±‚ã€‚å¦‚æœæ˜¯ï¼Œå®ƒä¼šè§£æåŸå§‹æç¤ºè¯ï¼Œ
        æå–ç”¨æˆ·çš„æŸ¥è¯¢å’Œæ¥è‡ªä¸åŒæ¨¡å‹çš„å“åº”ã€‚ç„¶åï¼Œå®ƒä¼šåŠ¨æ€æ„å»ºä¸€ä¸ªæ–°çš„ã€ç»“æ„æ›´æ¸…æ™°çš„æç¤ºè¯ï¼Œ
        å¹¶ç”¨å®ƒæ›¿æ¢åŸå§‹çš„æ¶ˆæ¯å†…å®¹ã€‚

        å‚æ•°:
            body (dict): åŒ…å«æ¶ˆæ¯çš„è¯·æ±‚ä½“ã€‚
            user (Optional[dict]): ç”¨æˆ·ä¿¡æ¯ã€‚

        è¿”å›:
            dict: åŒ…å«ä¼˜åŒ–åæç¤ºè¯çš„å·²ä¿®æ”¹è¯·æ±‚ä½“ã€‚
        """
        print(f"pipe:{__name__}")

        messages = body.get("messages", [])
        if not messages:
            return body

        user_message_content = ""
        user_message_index = -1

        # æ‰¾åˆ°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
        for i in range(len(messages) - 1, -1, -1):
            if messages[i].get("role") == "user":
                content = messages[i].get("content", "")
                # å¤„ç†å†…å®¹ä¸ºæ•°ç»„çš„æƒ…å†µï¼ˆå¤šæ¨¡æ€æ¶ˆæ¯ï¼‰
                if isinstance(content, list):
                    # ä»æ•°ç»„ä¸­æå–æ‰€æœ‰æ–‡æœ¬å†…å®¹
                    text_parts = []
                    for item in content:
                        if isinstance(item, dict) and item.get("type") == "text":
                            text_parts.append(item.get("text", ""))
                        elif isinstance(item, str):
                            text_parts.append(item)
                    user_message_content = "".join(text_parts)
                elif isinstance(content, str):
                    user_message_content = content

                user_message_index = i
                break

        if user_message_index == -1:
            return body

        # æ£€æŸ¥æ˜¯å¦ä¸ºMoEæ±‡æ€»è¯·æ±‚
        if isinstance(user_message_content, str) and user_message_content.startswith(
            "You have been provided with a set of responses from various models to the latest user query"
        ):
            print("æ£€æµ‹åˆ°MoEæ±‡æ€»è¯·æ±‚ï¼Œæ­£åœ¨æ›´æ”¹æç¤ºè¯ã€‚")

            # 1. æå–åŸå§‹æŸ¥è¯¢
            query_start_phrase = 'the latest user query: "'
            query_end_phrase = '"\n\nYour task is to'
            start_index = user_message_content.find(query_start_phrase)
            end_index = user_message_content.find(query_end_phrase)

            original_query = ""
            if start_index != -1 and end_index != -1:
                original_query = user_message_content[
                    start_index + len(query_start_phrase) : end_index
                ]

            # 2. æå–å„ä¸ªæ¨¡å‹çš„å“åº”
            responses_start_phrase = "Responses from models: "
            responses_start_index = user_message_content.find(responses_start_phrase)

            responses_text = ""
            if responses_start_index != -1:
                responses_text = user_message_content[
                    responses_start_index + len(responses_start_phrase) :
                ]

            # ä½¿ç”¨ä¸‰é‡åŒå¼•å·ä½œä¸ºåˆ†éš”ç¬¦æ¥æå–å“åº”
            responses = [
                part.strip() for part in responses_text.split('"""') if part.strip()
            ]

            # 3. åŠ¨æ€æ„å»ºæ¨¡å‹å“åº”éƒ¨åˆ†
            responses_section = ""
            for i, response in enumerate(responses):
                responses_section += f'''"""
[ç¬¬ {i + 1} ä¸ªæ¨¡å‹çš„å®Œæ•´å›ç­”]
{response}
"""
'''

            # 4. æ„å»ºæ–°çš„æç¤ºè¯
            merge_prompt = f'''# è§’è‰²å®šä½
ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„é¦–å¸­åˆ†æå¸ˆï¼Œæ­£åœ¨å¤„ç†æ¥è‡ªå¤šä¸ªç‹¬ç«‹ AI ä¸“å®¶å›¢é˜Ÿå¯¹åŒä¸€é—®é¢˜çš„åˆ†ææŠ¥å‘Šã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†è¿™äº›æŠ¥å‘Šè¿›è¡Œæ·±åº¦æ•´åˆã€æ‰¹åˆ¤æ€§åˆ†æï¼Œå¹¶æç‚¼å‡ºä¸€ä»½ç»“æ„æ¸…æ™°ã€æ´å¯Ÿæ·±åˆ»ã€å¯¹å†³ç­–è€…æå…·ä»·å€¼çš„ç»¼åˆæŠ¥å‘Šã€‚

# åŸå§‹ç”¨æˆ·é—®é¢˜
{original_query}

# è¾“å…¥æ ¼å¼è¯´æ˜ âš ï¸ é‡è¦
å„æ¨¡å‹çš„å“åº”å·²é€šè¿‡ """ ï¼ˆä¸‰é‡å¼•å·ï¼‰åˆ†éš”ç¬¦å‡†ç¡®è¯†åˆ«å’Œåˆ†ç¦»ã€‚ç³»ç»Ÿå·²å°†ä¸åŒæ¨¡å‹çš„å›ç­”åˆ†åˆ«æå–ï¼Œä½ ç°åœ¨éœ€è¦åŸºäºä»¥ä¸‹åˆ†ç¦»åçš„å†…å®¹è¿›è¡Œåˆ†æã€‚

**å·²åˆ†ç¦»çš„æ¨¡å‹å“åº”**:
{responses_section}
# æ ¸å¿ƒä»»åŠ¡
è¯·å‹¿ç®€å•åœ°å¤åˆ¶æˆ–æ‹¼æ¥åŸå§‹æŠ¥å‘Šã€‚ä½ éœ€è¦è¿ç”¨ä½ çš„ä¸“ä¸šåˆ†æèƒ½åŠ›ï¼Œå®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š

## 1. ä¿¡æ¯è§£æä¸è¯„ä¼° (Analysis & Evaluation)
- **å‡†ç¡®åˆ†éš”**: å·²æ ¹æ® """ åˆ†éš”ç¬¦ï¼Œå‡†ç¡®è¯†åˆ«æ¯ä¸ªæ¨¡å‹çš„å›ç­”è¾¹ç•Œã€‚
- **å¯ä¿¡åº¦è¯„ä¼°**: æ‰¹åˆ¤æ€§åœ°å®¡è§†æ¯ä»½æŠ¥å‘Šï¼Œè¯†åˆ«å…¶ä¸­å¯èƒ½å­˜åœ¨çš„åè§ã€é”™è¯¯æˆ–ä¸ä¸€è‡´ä¹‹å¤„ã€‚
- **é€»è¾‘æ¢³ç†**: ç†æ¸…æ¯ä»½æŠ¥å‘Šçš„æ ¸å¿ƒè®ºç‚¹ã€æ”¯æ’‘è®ºæ®å’Œæ¨ç†é“¾æ¡ã€‚

## 2. æ ¸å¿ƒæ´å¯Ÿæç‚¼ (Insight Extraction)
- **è¯†åˆ«å…±è¯†**: æ‰¾å‡ºæ‰€æœ‰æŠ¥å‘Šä¸­å…±åŒæåŠã€é«˜åº¦ä¸€è‡´çš„è§‚ç‚¹æˆ–å»ºè®®ã€‚è¿™é€šå¸¸æ˜¯é—®é¢˜çš„æ ¸å¿ƒäº‹å®æˆ–æœ€ç¨³å¥çš„ç­–ç•¥ã€‚
- **çªå‡ºå·®å¼‚**: æ˜ç¡®æŒ‡å‡ºå„æŠ¥å‘Šåœ¨è§†è§’ã€æ–¹æ³•ã€é¢„æµ‹æˆ–ç»“è®ºä¸Šçš„å…³é”®åˆ†æ­§ç‚¹ã€‚è¿™äº›åˆ†æ­§å¾€å¾€è•´å«ç€é‡è¦çš„æˆ˜ç•¥è€ƒé‡ã€‚
- **æ•æ‰äº®ç‚¹**: æŒ–æ˜å•ä¸ªæŠ¥å‘Šä¸­ç‹¬æœ‰çš„ã€å…·æœ‰åˆ›æ–°æ€§æˆ–æ·±åˆ»æ€§çš„è§è§£ï¼Œè¿™äº›"é—ªå…‰ç‚¹"å¯èƒ½æ˜¯å…³é”®çš„å·®å¼‚åŒ–ä¼˜åŠ¿ã€‚

## 3. ç»¼åˆæŠ¥å‘Šæ’°å†™ (Synthesis)
åŸºäºä»¥ä¸Šåˆ†æï¼Œç”Ÿæˆä¸€ä»½åŒ…å«ä»¥ä¸‹ç»“æ„çš„ç»¼åˆæŠ¥å‘Šï¼š

### **ã€æ ¸å¿ƒå…±è¯†ã€‘**
- ç”¨æ¸…æ™°çš„è¦ç‚¹åˆ—å‡ºæ‰€æœ‰æ¨¡å‹ä¸€è‡´è®¤åŒçš„å…³é”®ä¿¡æ¯æˆ–å»ºè®®ã€‚
- æ ‡æ³¨è¦†ç›–èŒƒå›´ï¼ˆå¦‚"æ‰€æœ‰æ¨¡å‹å‡åŒæ„"æˆ–"å¤šæ•°æ¨¡å‹æåŠ"ï¼‰ã€‚

### **ã€å…³é”®åˆ†æ­§ã€‘**
- æ¸…æ™°åœ°å¯¹æ¯”ä¸åŒæ¨¡å‹åœ¨å“ªäº›æ ¸å¿ƒé—®é¢˜ä¸ŠæŒæœ‰ä¸åŒè§‚ç‚¹ã€‚
- ç”¨åºå·æˆ–æè¿°æ€§è¯­è¨€æ ‡è¯†ä¸åŒçš„è§‚ç‚¹é˜µè¥ï¼ˆå¦‚"è§‚ç‚¹ A ä¸è§‚ç‚¹ B çš„åˆ†æ­§"æˆ–"æ–¹æ¡ˆ 1 vs æ–¹æ¡ˆ 2"ï¼‰ã€‚
- ç®€è¦è¯´æ˜å…¶åŸå› æˆ–ä¾§é‡ç‚¹çš„å·®å¼‚ã€‚

### **ã€ç‹¬ç‰¹æ´å¯Ÿã€‘**
- æç‚¼å¹¶å‘ˆç°é‚£äº›ä»…åœ¨å•ä¸ªæŠ¥å‘Šä¸­å‡ºç°ï¼Œä½†æå…·ä»·å€¼çš„ç‹¬ç‰¹å»ºè®®æˆ–è§†è§’ã€‚
- ç”¨"æŸä¸ªæ¨¡å‹æå‡º"æˆ–"å¦ä¸€è§†è§’"ç­‰ä¸­ç«‹è¡¨è¿°ï¼Œé¿å…å› ç¼ºå°‘æ˜¾å¼æ¥æºæ ‡è®°è€Œé€ æˆçš„æ··æ·†ã€‚

### **ã€ç»¼åˆåˆ†æä¸å»ºè®®ã€‘**
- **æ•´åˆ**: åŸºäºå…±è¯†ã€å·®å¼‚å’Œäº®ç‚¹ï¼Œæä¾›ä¸€ä¸ªå…¨é¢ã€å¹³è¡¡ã€ä¸”ç»è¿‡ä½ ä¸“ä¸šåˆ¤æ–­ä¼˜åŒ–çš„æœ€ç»ˆåˆ†æã€‚
- **å»ºè®®**: å¦‚æœåŸå§‹æŒ‡ä»¤æ˜¯å¯»æ±‚æ–¹æ¡ˆæˆ–ç­–ç•¥ï¼Œè¿™é‡Œåº”æå‡ºä¸€ä¸ªæˆ–å¤šä¸ªèåˆäº†å„æ–¹ä¼˜åŠ¿çš„ã€å¯æ‰§è¡Œçš„å»ºè®®ã€‚

# æ ¼å¼è¦æ±‚
- è¯­è¨€ç²¾ç‚¼ã€é€»è¾‘æ¸…æ™°ã€ç»“æ„åˆ†æ˜ã€‚
- ä½¿ç”¨åŠ ç²—ã€åˆ—è¡¨ã€æ ‡é¢˜ç­‰æ ¼å¼ï¼Œç¡®ä¿æŠ¥å‘Šæ˜“äºé˜…è¯»å’Œç†è§£ã€‚
- ç”±äºç¼ºå°‘æ˜¾å¼çš„æ¨¡å‹æ ‡è¯†ï¼Œ**åœ¨å‘ˆç°å·®å¼‚åŒ–è§‚ç‚¹æ—¶ï¼Œä½¿ç”¨æè¿°æ€§æˆ–åºå·åŒ–çš„æ–¹å¼**ï¼ˆå¦‚"ç¬¬ä¸€ç§è§‚ç‚¹""å¦ä¸€ä¸ªè§†è§’"ï¼‰è€Œéå…·ä½“çš„æ¨¡å‹åç§°ã€‚
- å§‹ç»ˆä»¥"ä¸ºç”¨æˆ·æä¾›æœ€é«˜ä»·å€¼çš„å†³ç­–ä¾æ®"ä¸ºç›®æ ‡ã€‚

# è¾“å‡ºç»“æ„ç¤ºä¾‹
æ ¹æ®ä»¥ä¸Šè¦æ±‚ï¼Œä½ çš„è¾“å‡ºåº”è¯¥å‘ˆç°å¦‚ä¸‹ç»“æ„ï¼š

## ã€æ ¸å¿ƒå…±è¯†ã€‘
âœ“ [å…±è¯†è§‚ç‚¹ 1] â€”â€” æ‰€æœ‰æ¨¡å‹å‡åŒæ„
âœ“ [å…±è¯†è§‚ç‚¹ 2] â€”â€” å¤šæ•°æ¨¡å‹åŒæ„

## ã€å…³é”®åˆ†æ­§ã€‘
âš¡ **åœ¨[è®®é¢˜]ä¸Šçš„åˆ†æ­§**:
- è§‚ç‚¹é˜µè¥ A: ...
- è§‚ç‚¹é˜µè¥ B: ...
- è§‚ç‚¹é˜µè¥ C: ...

## ã€ç‹¬ç‰¹æ´å¯Ÿã€‘
ğŸ’¡ [æŸä¸ªæ¨¡å‹ç‹¬æœ‰çš„æ·±åˆ»è§‚ç‚¹]: ...
ğŸ’¡ [å¦ä¸€ä¸ªæ¨¡å‹çš„åˆ›æ–°è§†è§’]: ...

## ã€ç»¼åˆåˆ†æä¸å»ºè®®ã€‘
åŸºäºä»¥ä¸Šåˆ†æï¼Œæ¨èæ–¹æ¡ˆ/ç­–ç•¥: ...
'''

            # 5. æ›¿æ¢åŸå§‹æ¶ˆæ¯å†…å®¹
            body["messages"][user_message_index]["content"] = merge_prompt
            print("æç¤ºè¯å·²æˆåŠŸåŠ¨æ€æ›¿æ¢ã€‚")

        return body
