# GitHub Actions Workflow for Plugin Version Change Detection
# æ’ä»¶ç‰ˆæœ¬å˜åŒ–æ£€æµ‹å·¥ä½œæµ
#
# This workflow detects version changes in plugins when PRs are created or updated.
# æ­¤å·¥ä½œæµåœ¨åˆ›å»ºæˆ–æ›´æ–° PR æ—¶æ£€æµ‹æ’ä»¶çš„ç‰ˆæœ¬å˜åŒ–ã€‚
#
# What it does:
# 1. Compares plugin versions between base and head branches
# 2. Generates a summary of version changes
# 3. Comments on the PR with the changes
# 4. FAILS the check if plugin files are modified but no version update is detected
#    (enforces version bump requirement for plugin changes)

name: Plugin Version Check / æ’ä»¶ç‰ˆæœ¬æ£€æŸ¥

on:
  pull_request:
    branches:
      - main
    paths:
      - 'plugins/**/*.py'

permissions:
  contents: read
  pull-requests: write

jobs:
  check-versions:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: head

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Extract and compare versions
        id: compare
        run: |
          # Extract base versions
          cd base
          if [ -f scripts/extract_plugin_versions.py ]; then
            python scripts/extract_plugin_versions.py --json --output ../base_versions.json
          else
            # Fallback if script doesn't exist in base
            echo "[]" > ../base_versions.json
          fi
          cd ..
          
          # Extract head versions
          cd head
          python scripts/extract_plugin_versions.py --json --output ../head_versions.json
          
          # Compare versions
          python scripts/extract_plugin_versions.py --compare ../base_versions.json --output ../changes.md
          cd ..
          
          echo "=== Version Changes ==="
          cat changes.md
          
          # Check if there are any changes
          if grep -q "No changes detected" changes.md; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
          
          # Store changes for comment
          {
            echo 'changes<<EOF'
            cat changes.md
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Check PR description for update notes
        id: check_description
        if: steps.compare.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            
            // Check if PR has meaningful description (at least 20 characters, excluding whitespace)
            // Use [\s\S]*? for multiline HTML comment matching (compatible across JS engines)
            const cleanBody = prBody.replace(/\s+/g, '').replace(/<!--[\s\S]*?-->/g, '');
            const hasDescription = cleanBody.length >= 20;
            
            console.log(`PR body length (cleaned): ${cleanBody.length}`);
            console.log(`Has meaningful description: ${hasDescription}`);
            
            core.setOutput('has_description', hasDescription.toString());
            return hasDescription;

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const hasChanges = '${{ steps.compare.outputs.has_changes }}' === 'true';
            const hasDescription = '${{ steps.check_description.outputs.has_description }}' === 'true';
            const changes = `${{ steps.compare.outputs.changes }}`;
            
            let statusIcon = '';
            let statusMessage = '';
            
            if (hasChanges && hasDescription) {
              statusIcon = 'âœ…';
              statusMessage = 'ç‰ˆæœ¬æ›´æ–°æ£€æµ‹é€šè¿‡ï¼PR åŒ…å«ç‰ˆæœ¬å˜åŒ–å’Œæ›´æ–°è¯´æ˜ã€‚\n\nVersion check passed! PR contains version changes and update description.';
            } else if (hasChanges && !hasDescription) {
              statusIcon = 'âš ï¸';
              statusMessage = 'æ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°ï¼Œä½† PR æè¿°è¿‡çŸ­ã€‚è¯·åœ¨ PR æè¿°ä¸­æ·»åŠ æ›´æ–°è¯´æ˜ï¼ˆè‡³å°‘ 20 ä¸ªå­—ç¬¦ï¼‰ã€‚\n\nVersion update detected, but PR description is too short. Please add update notes in PR description (at least 20 characters).';
            } else {
              statusIcon = 'âŒ';
              statusMessage = 'æœªæ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°ï¼ä¿®æ”¹æ’ä»¶æ–‡ä»¶æ—¶å¿…é¡»æ›´æ–°ç‰ˆæœ¬å·ã€‚\n\nNo version update detected! You must update the version number when modifying plugin files.';
            }
            
            const body = `## ${statusIcon} Plugin Version Check / æ’ä»¶ç‰ˆæœ¬æ£€æŸ¥
            
            ${statusMessage}
            
            ---
            
            ${hasChanges ? `### ç‰ˆæœ¬å˜åŒ– / Version Changes\n\n${changes}` : ''}
            
            ---
            *This comment was generated automatically. / æ­¤è¯„è®ºç”±è‡ªåŠ¨ç”Ÿæˆã€‚*
            `;
            
            // Find existing comment from github-actions bot
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              (comment.user.login === 'github-actions[bot]' || comment.user.type === 'Bot') && 
              comment.body.includes('Plugin Version Check')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      - name: Enforce version update requirement
        if: steps.compare.outputs.has_changes == 'false'
        run: |
          echo "::error::âŒ æœªæ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°ï¼ä¿®æ”¹æ’ä»¶æ–‡ä»¶æ—¶å¿…é¡»æ›´æ–°ç‰ˆæœ¬å·ã€‚"
          echo "::error::No version update detected! You must update the version number when modifying plugin files."
          echo ""
          echo "è¯·åœ¨æ’ä»¶æ–‡ä»¶çš„ docstring ä¸­æ›´æ–°ç‰ˆæœ¬å·ï¼š"
          echo "Please update the version in your plugin's docstring:"
          echo ""
          echo '"""'
          echo 'title: Your Plugin'
          echo 'version: 0.2.0  # <- æ›´æ–°æ­¤å¤„ / Update this'
          echo '...'
          echo '"""'
          exit 1

      - name: Enforce PR description requirement
        if: steps.compare.outputs.has_changes == 'true' && steps.check_description.outputs.has_description == 'false'
        run: |
          echo "::error::âš ï¸ PR æè¿°è¿‡çŸ­ï¼è¯·æ·»åŠ æ›´æ–°è¯´æ˜ã€‚"
          echo "::error::PR description is too short! Please add update notes."
          echo ""
          echo "è¯·åœ¨ PR æè¿°ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š"
          echo "Please add the following to your PR description:"
          echo ""
          echo "- æ›´æ–°äº†å“ªäº›åŠŸèƒ½ / What features were updated"
          echo "- ä¿®å¤äº†å“ªäº›é—®é¢˜ / What issues were fixed"
          echo "- å…¶ä»–é‡è¦å˜æ›´ / Other important changes"
          exit 1

      - name: Summary
        run: |
          echo "## ğŸ” Plugin Version Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.compare.outputs.has_changes }}" = "true" ]; then
            echo "âœ… **Version changes detected!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat changes.md >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.check_description.outputs.has_description }}" = "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **PR description check passed!**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **No version changes detected - check failed!**" >> $GITHUB_STEP_SUMMARY
          fi
